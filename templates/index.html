<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="Author" content="grupi">
    <meta name="Description" content="BookStore">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PageAPI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>
</head>
<body>
    <header>
        <nav class="navigation-links">
            <div class="actual-links-top">
                <ul class="logo-and-title">
                    <svg id="page-api-logo" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M12 18l.01 0" />
                        <path d="M9.172 15.172a4 4 0 0 1 5.656 0" />
                        <path d="M6.343 12.343a7.963 7.963 0 0 1 3.864 -2.14m4.163 .155a7.965 7.965 0 0 1 3.287 2" />
                        <path d="M3.515 9.515a12 12 0 0 1 3.544 -2.455m3.101 -.92a12 12 0 0 1 10.325 3.374" />
                        <path d="M3 3l18 18" />
                    </svg>
                    <li id="webapp-title"><a href="{{ url_for('index') }}">PageAPI</a></li>
                </ul>
                <ul class="links-right-side">
                    {% for section_id, link_text, _ in nav_categories %}
                    <li><a href="#{{ section_id }}">{{ link_text }}</a></li>
                    {% endfor %}

                    <li><a href="{{ url_for('cart') }}">Shporta {% if cart_count > 0 %}({{ cart_count }}){% endif %}</a></li>
                    <li><a href="{{ url_for('favorites_page') }}">Të Preferuara {% if favorites_count > 0 %}({{ favorites_count }}){% endif %}</a></li>

                    {% if 'user_email' in session %}
                        <li style="color: #5595ed; font-weight: 600;">
                             {{ session['user_email'] }}
                        </li>
                        <li><a href="{{ url_for('logout') }}" style="color: #e74c3c; font-weight: 500;">Dil</a></li>
                    {% else %}
                        <button id="sign-in" onclick="window.location.href='{{ url_for('login') }}'">Sign in</button>
                    {% endif %}
                </ul>
            </div>
            <div class="search-engine-top">
                <div class="box-for-search">
                    <svg id="search-svg" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                        <path d="M21 21l-6 -6" />
                    </svg>
                    <!-- Changed to input event for better UX -->
                    <input type="text" id="search-input" placeholder="Kerko librat..." oninput="searchBooks()">
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="main-intro-page">
            <div class="first-part">
                <div class="img-in-intro">
                    <img id="img-chosen" src="{{ url_for('static', filename='images/cool-laptop-pic.jpg') }}" alt="laptop">
                </div>
                <div class="about-intro">
                    <h2>pageAPI</h2>
                    <p>
                    pageAPI is your all-in-one resource hub for developers.
                    Whether you're missing documentation, code examples, or foundational knowledge,
                    pageAPI delivers fast, reliable, and structured programming resources
                    to help you build, debug, and learn — without the endless searching.
                    </p>
                    {% if 'user_email' in session %}
                        <button id="part-sign-in" onclick="window.location.href='{{ url_for('logout') }}'">Dil</button>
                    {% else %}
                        <button id="part-sign-in" onclick="window.location.href='{{ url_for('login') }}'">Sign in</button>
                    {% endif %}
                </div>
            </div>
            <div class="more-info-svg">
                <div class="quality-svg-info">
                    <svg class="quality-svg-logo" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M8.243 7.34l-6.38 .925l-.113 .023a1 1 0 0 0 -.44 1.684l4.622 4.499l-1.09 6.355l-.013 .11a1 1 0 0 0 1.464 .944l5.706 -3l5.693 3l.1 .046a1 1 0 0 0 1.352 -1.1l-1.091 -6.355l4.624 -4.5l.078 -.085a1 1 0 0 0 -.633 -1.62l-6.38 -.926l-2.852 -5.78a1 1 0 0 0 -1.794 0l-2.853 5.78z" />
                    </svg>
                    <div class="quality-text">
                        <h2>Quality</h2>
                        <p>Each book added to our shelves undergoes a thorough quality check.</p>
                    </div>
                </div>
                <div class="quality-svg-info">
                    <svg class="quality-svg-logo" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M4.698 4.034l16.302 7.966l-16.302 7.966a.503 .503 0 0 1 -.546 -.124a.555 .555 0 0 1 -.12 -.568l2.468 -7.274l-2.468 -7.274a.555 .555 0 0 1 .12 -.568a.503 .503 0 0 1 .546 -.124z" />
                        <path d="M6.5 12h14.5" />
                    </svg>
                    <div class="delivery-text">
                        <h2>Delivery</h2>
                        <p>Can't make it into the library? No problem.The library comes to you.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Books -->
        <div id="all-books">
            {% for section_id, _, category_name in nav_categories %}
            <div class="row" id="{{ section_id }}">
                <h2 class="h2-title-books">{{ category_name }}</h2>
                <div class="book-content">
                    {% for book in books[category_name] %}
                    <div class="bookkk">
                        <img src="{{ url_for('static', filename='images/' + book.img) }}" class="books-photos" alt="{{ book.title }}">
                        <p class="book-title">{{ book.title }}</p>
                        <p class="book-price">
                            {{ book.price }}
                            <svg class="heart-svg {% if book.id in favorite_ids %}favorited{% endif %}"
                                 onclick="toggleFavorite({{ book.id }}, this)"
                                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572"/>
                            </svg>
                        </p>
                        <button class="blerja" onclick="addToCart({{ book.id }})">
                            Shto në shportë
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Search Results -->
        <div id="search-results" style="display: none;">
            <h2 style="text-align: center; padding: 20px;">Rezultatet e kërkimit</h2>
            <div id="search-books-container" class="book-content"></div>
            <p style="text-align: center; margin: 20px;">
                <a href="{{ url_for('index') }}" style="color: #5595ed;">Kthehu te të gjitha librat</a>
            </p>
        </div>

        <!-- Footer -->
        <div class="footer" id="five">
            <div class="footer-starter help">
                <h3>Libraria PageAPI</h3>
                <p>Numri kontaktues +383 44-155-155</p>
                <div class="footer-icons">
                    <!-- Your icons -->
                </div>
            </div>
            <div class="help">
                <h3>Të duhet ndihmë?</h3>
                <ul>
                    <li><a href="#">Ndihmë</a></li>
                    <li><a href="#">Rreth Nesh</a></li>
                    <li><a href="#">Politika e privatësisë</a></li>
                </ul>
                <p>&copy; 2025 Libraria PageAPI. All Rights Reserved.</p>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        // All books as safe JS array - NO JINJA LOOP IN JS
        const allBooks = {{ books|tojson }};

        // Convert books dict to flat array
        const flatBooks = [];
        Object.values(allBooks).forEach(categoryBooks => {
            categoryBooks.forEach(book => {
                flatBooks.push(book);
            });
        });

        const favoriteIds = [{{ favorite_ids|join(',') or '' }}];

        function searchBooks() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const allBooksDiv = document.getElementById('all-books');
            const resultsDiv = document.getElementById('search-results');
            const container = document.getElementById('search-books-container');

            if (query === '') {
                allBooksDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                return;
            }

            const filtered = flatBooks.filter(book => 
                book.title.toLowerCase().includes(query)
            );

            allBooksDiv.style.display = 'none';
            resultsDiv.style.display = 'block';

            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:40px;">Nuk u gjet asnjë libër për "' + query + '"</p>';
            } else {
                container.innerHTML = filtered.map(book => `
                    <div class="bookkk">
                        <img src="/static/images/${book.img}" class="books-photos" alt="${book.title}">
                        <p class="book-title">${book.title}</p>
                        <p class="book-price">
                            ${book.price}
                            <svg class="heart-svg ${favoriteIds.includes(book.id) ? 'favorited' : ''}"
                                 onclick="toggleFavorite(${book.id}, this)"
                                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572"/>
                            </svg>
                        </p>
                        <button class="blerja" onclick="addToCart(${book.id})">
                            Shto në shportë
                        </button>
                    </div>
                `).join('');
            }
        }

        function addToCart(bookId) {
            fetch('/add_to_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ book_id: bookId })
            })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                location.reload();
            })
            .catch(() => alert('Gabim!'));
        }

        function toggleFavorite(bookId, element) {
            fetch('/add_to_favorites', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ book_id: bookId })
            })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    element.classList.add('favorited');
                    location.reload();
                }
            })
            .catch(() => alert('Gabim!'));
        }
    </script>

    <style>
        .heart-svg {
            width: 24px;
            height: 24px;
            cursor: pointer;
            stroke: #666;
            fill: none;
            transition: all 0.3s ease;
            margin-left: 8px;
            vertical-align: middle;
        }
        .heart-svg.favorited {
            fill: #e74c3c;
            stroke: #e74c3c;
        }
        .heart-svg:hover {
            transform: scale(1.2);
            stroke: #e74c3c;
        }

        #search-results {
            background: #f8f9fa;
            padding: 30px;
            margin-top: 40px;
            border-top: 3px solid #5595ed;
        }

        #search-books-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
    </style>
</body>
</html>
